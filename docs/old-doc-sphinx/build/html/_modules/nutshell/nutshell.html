<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>nutshell.nutshell &mdash; NutShell 1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../_static/nutshell-logo.ico"/>
    <link rel="top" title="NutShell 1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="header-wrapper" role="banner">
      <div class="header">
          <p class="logo"><a href="../../index.html">
            <img class="logo" src="../../_static/nutshell-logo-small.png" alt="Logo"/>
          </a></p>
        <div class="headertitle"><a
          href="../../index.html">NutShell 1 documentation</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for nutshell.nutshell</h1><div class="highlight"><pre>
<span class="ch">#!/bin/python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Product generator service appicable on the command line or as a library</span>

<span class="sd">Command line usage</span>
<span class="sd">==================</span>

<span class="sd">Basic format for all the command line invocations is::</span>

<span class="sd">    python3 -m nutshell.nutshell &lt;nutshell-args&gt;</span>
<span class="sd">    </span>
<span class="sd">Online help is optained with ``-h``::</span>

<span class="sd">    python3 -m nutshell.nutshell -h</span>
<span class="sd">    </span>
<span class="sd">Simple query using configuration file and product definition::</span>

<span class="sd">    python3 -m nutshell.nutshell -c nutshell/nutshell.cnf -m \\</span>
<span class="sd">      -p 201708121500_radar.rack.comp_SIZE=800,800_SITES=fiika_BBOX=20,62,30,70.png </span>


<span class="sd">Using NutShell within python</span>
<span class="sd">============================</span>

<span class="sd">Simple example::</span>

<span class="sd">    import nutshell.nutshell as nuts</span>

<span class="sd">    # Initilize service</span>
<span class="sd">    server = nuts.ProductServer(&#39;nutshell/nutshell.cnf&#39;)</span>

<span class="sd">    # Retrieve / generate a product</span>
<span class="sd">    response = server.make_request(&quot;201708121600_radar.rack.comp_SITES=fikor,fivan,fiika_SIZE=800,800.png&quot;, &quot;MAKE&quot;)</span>

<span class="sd">    # Results:</span>
<span class="sd">    # - error code returned by script (generate.sh)  </span>
<span class="sd">    print(&quot;Return code: {0} &quot;.format(response.returncode))</span>
<span class="sd">    # -   </span>
<span class="sd">    print(&quot;Status (HTTP code): {0}: {0} &quot;.format(response.status))</span>
<span class="sd">    print(&quot;File path: {0} &quot;.format(response.returncode))</span>

<span class="sd">    # Further processing, image example</span>
<span class="sd">    from PIL import Image</span>
<span class="sd">    file = Image.open(response.path)</span>
<span class="sd">    print(file.info)</span>


<span class="sd">Status codes</span>
<span class="sd">============</span>

<span class="sd">NutShell recycles HTTP status codes in communicating success or failure</span>
<span class="sd">on operations. Especially:</span>

<span class="sd">=====  ============</span>
<span class="sd">Code   Enum Name</span>
<span class="sd">=====  ============</span>
<span class="sd">102    PROCESSING</span>
<span class="sd">200    OK</span>
<span class="sd">=====  ============</span>

<span class="sd">References:</span>
<span class="sd">- https://docs.python.org/3/library/http.html</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;0.1&#39;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Markus.Peura@fmi.fi&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="c1"># for shell escape</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">HTTPStatus</span>
<span class="c1">#import http.server</span>
<span class="c1">#HTTPresponses = http.server.SimpleHTTPRequestHandler.responses</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(levelname)s</span><span class="se">\t</span><span class="s1"> </span><span class="si">%(name)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1">#logging.basicConfig(format=&#39;%(levelname)s:%(message)s&#39;, level=logging.DEBUG)</span>
<span class="c1">#logging.basicConfig(format=&#39;%(asctime)s %(message)s&#39;, datefmt=&#39;%m/%d/%Y %I:%M:%S %p&#39;)</span>
<span class="c1">#logging.basicConfig(format=&#39;%(asctime)s %(levelname)s %(name)s : %(message)s&#39;, datefmt=&#39;%Y%m%d%H:%M:%S&#39;)</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">nutils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">nutproduct</span>




<span class="k">def</span> <span class="nf">parse_timestamp2</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="p">{}):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;\W&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span> <span class="c1"># empty ok?</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;YEAR&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;MONTH&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;DAY&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;HOUR&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;MINUTE&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>




<span class="n">ProductInfo</span> <span class="o">=</span> <span class="n">nutproduct</span><span class="o">.</span><span class="n">ProductInfo</span>


<div class="viewcode-block" id="ProductServer"><a class="viewcode-back" href="../../nutshell-main.html#nutshell.nutshell.ProductServer">[docs]</a><span class="k">class</span> <span class="nc">ProductServer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Service designed for generating image and data products served as files </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">PRODUCT_ROOT</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
    <span class="n">CACHE_ROOT</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
    <span class="n">TIME_DIR_SYNTAX</span> <span class="o">=</span> <span class="s1">&#39;{YEAR}/{MONTH}/{DAY}&#39;</span>
    <span class="n">SHELL_GENERATOR_SCRIPT</span> <span class="o">=</span> <span class="s1">&#39;generate.sh&#39;</span>
    <span class="n">SHELL_INPUT_SCRIPT</span> <span class="o">=</span> <span class="s1">&#39;input.sh&#39;</span>

    <span class="c1"># HTTP Server Options (forward defs HTTP server, so perhaps later moved to NutServer )</span>
    <span class="n">HTTP_PORT</span> <span class="o">=</span> <span class="mi">8088</span>
    <span class="n">HTTP_NAME</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">HTTP_PATH_PREFIX</span> <span class="o">=</span> <span class="s1">&#39;nutshell/&#39;</span> <span class="c1"># todo</span>
    <span class="n">HTML_ROOT</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="c1"># todo</span>
    <span class="n">HTML_TEMPLATE</span> <span class="o">=</span> <span class="s1">&#39;template.html&#39;</span> 

    <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
    <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>

    <span class="c1">#verbosity = 5</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#error_code_regexp = re.compile(&quot;^\s*([0-9]+)\\.(zip|gz)$&quot;)</span>
   
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ProductServer.get_arg_parser"><a class="viewcode-back" href="../../nutshell-main.html#nutshell.nutshell.ProductServer.get_arg_parser">[docs]</a>    <span class="k">def</span> <span class="nf">get_arg_parser</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">parser</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populates parser with options of this class&quot;&quot;&quot;</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">nutproduct</span><span class="o">.</span><span class="n">ProductInfo</span><span class="o">.</span><span class="n">get_arg_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="c1"># parser = argparse.ArgumentParser()</span>
 
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;--conf&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;CONF&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="c1"># &quot;nutshell.cnf&quot;, #ProductServer.CONF_FILE?</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;read config file&quot;</span><span class="p">,</span> 
                            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;file&gt;&quot;</span><span class="p">)</span>
     
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="s2">&quot;--request&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">,</span>
                            <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;REQUEST&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;comma-separated string of [DELETE|MAKE|INPUTS]&quot;</span><span class="p">)</span>
    
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="s2">&quot;--delete&quot;</span><span class="p">,</span>
                            <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;DELETE&quot;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                            <span class="c1">#default=False,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;delete product file, same as -r DELETE&quot;</span><span class="p">)</span>
    
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;--make&quot;</span><span class="p">,</span>
                            <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;MAKE&quot;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                            <span class="c1">#default=False,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;make product, same as -r MAKE&quot;</span><span class="p">)</span>
    
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;--inputList&quot;</span><span class="p">,</span>
                            <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;INPUTS&quot;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;list input for a product, same as -r INPUTS&quot;</span><span class="p">)</span>
    
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-D&quot;</span><span class="p">,</span> <span class="s2">&quot;--directives&quot;</span><span class="p">,</span>
                            <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;DIRECTIVES&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;additional instructions: LOG,LINK,LATEST&quot;</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">parser</span>    </div>

    
        
<div class="viewcode-block" id="ProductServer.ProductRequest"><a class="viewcode-back" href="../../nutshell-main.html#nutshell.nutshell.ProductServer.ProductRequest">[docs]</a>    <span class="k">class</span> <span class="nc">ProductRequest</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Container for storing information on requested product and server side resources derived thereof.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="sd">&quot;&quot;&quot;Server assigned for manufacturing this product&quot;&quot;&quot;</span>
        <span class="n">product_server</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="sd">&quot;&quot;&quot;Specification of a product instance.&quot;&quot;&quot;</span>
        <span class="n">product_info</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="sd">&quot;&quot;&quot;System-side directory containing script () for generating the product&quot;&quot;&quot;</span>
        <span class="n">generator_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="sd">&quot;&quot;&quot;System-side full path to a dynamic directory and the generated product file.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        
        <span class="sd">&quot;&quot;&quot;System-side full path to the generated file, the product.&quot;&quot;&quot;</span>
        <span class="n">path_static</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>        
        
        <span class="sd">&quot;&quot;&quot;Optional: System-side full path to the generated product file.&quot;&quot;&quot;</span>
        <span class="n">path_tmp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
     
        <span class="sd">&quot;&quot;&quot;Optional: Actual object (for example, python Image in the future) &quot;&quot;&quot;</span>
        <span class="n">product</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Later, use (dir + file) object</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">directives</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Nutshell native log output</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Std output of the generation</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Error output of the generation</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Return code of the generation</span>
        <span class="n">returncode</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Status, defined using HTTP status codes</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span>

        <span class="n">sid</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">builtin_directives</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;LOG&quot;</span><span class="p">,</span> <span class="s2">&quot;LATEST&quot;</span><span class="p">,</span> <span class="s2">&quot;LINK&quot;</span><span class="p">)</span>        

<div class="viewcode-block" id="ProductServer.ProductRequest.set_status"><a class="viewcode-back" href="../../nutshell-main.html#nutshell.nutshell.ProductServer.ProductRequest.set_status">[docs]</a>        <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Set success or failure status using http.HTTPStatus codes.</span>
<span class="sd">            This is always logged.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span></div>
        
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_server</span><span class="p">,</span> <span class="n">product_info</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">directives</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="n">ProductServer</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span>

            <span class="c1"># Consider stripping &#39;product_&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">product_server</span> <span class="o">=</span> <span class="n">product_server</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">product_info</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">product_info</span> <span class="o">=</span> <span class="n">ProductInfo</span><span class="p">(</span><span class="n">product_info</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>        
                <span class="bp">self</span><span class="o">.</span><span class="n">product_info</span> <span class="o">=</span> <span class="n">product_info</span>

            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;ProductRequest&quot;</span><span class="p">)</span>
 
            <span class="k">if</span> <span class="p">(</span><span class="n">actions</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="n">actions</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;actions:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">actions</span><span class="p">))</span>
  
            <span class="k">if</span> <span class="p">(</span><span class="n">directives</span><span class="p">):</span>              
                <span class="bp">self</span><span class="o">.</span><span class="n">directives</span> <span class="o">=</span> <span class="n">directives</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">directives</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;directives: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directives</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">generator_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">product_server</span><span class="o">.</span><span class="n">get_generator_dir</span><span class="p">(</span><span class="n">product_info</span><span class="p">),</span> 
                                       <span class="n">product_server</span><span class="o">.</span><span class="n">SHELL_GENERATOR_SCRIPT</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1">#self.log = nutils.Log()</span>
           
            <span class="n">filename</span>        <span class="o">=</span> <span class="n">product_info</span><span class="o">.</span><span class="n">filename</span><span class="p">()</span>
            <span class="n">filename_latest</span> <span class="o">=</span> <span class="n">product_info</span><span class="o">.</span><span class="n">filename_latest</span><span class="p">()</span>
            <span class="c1">#cache_dir_dyn = product_server.get_dynamic_cache_dir(product_info)</span>
            <span class="c1">#cache_dir = product_server.get_cache_dir(product_info)</span>
            <span class="n">cache_root</span> <span class="o">=</span> <span class="n">product_server</span><span class="o">.</span><span class="n">CACHE_ROOT</span>
            <span class="n">time_dir</span> <span class="o">=</span> <span class="n">product_server</span><span class="o">.</span><span class="n">get_time_dir</span><span class="p">(</span><span class="n">product_info</span><span class="p">)</span>
            <span class="n">prod_dir</span> <span class="o">=</span> <span class="n">product_server</span><span class="o">.</span><span class="n">get_product_dir</span><span class="p">(</span><span class="n">product_info</span><span class="p">)</span>
      
      
            <span class="c1"># Target path. Will be cleared (to None) if product generation fails.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_relative</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">time_dir</span><span class="p">,</span> <span class="n">prod_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span>        <span class="n">Path</span><span class="p">(</span><span class="n">cache_root</span><span class="p">,</span> <span class="n">time_dir</span><span class="p">,</span> <span class="n">prod_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_tmp</span> <span class="o">=</span>    <span class="n">Path</span><span class="p">(</span><span class="n">cache_root</span><span class="p">,</span> <span class="n">time_dir</span><span class="p">,</span> <span class="n">prod_dir</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>  
            <span class="bp">self</span><span class="o">.</span><span class="n">path_static</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cache_root</span><span class="p">,</span> <span class="n">prod_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_latest</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cache_root</span><span class="p">,</span> <span class="n">prod_dir</span><span class="p">,</span> <span class="n">filename_latest</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">NO_CONTENT</span><span class="p">)</span>  <span class="c1">#204 # No content</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span></div>
            
            <span class="c1"># self.path_tmp = self.cache_dir+os.sep+self.out_file_tmp</span>
   
    <span class="k">class</span> <span class="nc">_InputInfo</span><span class="p">:</span>
        
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Std output of the generation</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Error output of the generation</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1">#</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="n">returncode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#def __init__(self, product_info):</span>
        <span class="c1">#    self.gdir = self.get_generator_dir(product_info)</span>
        <span class="c1">#    self.inputs = {}</span>
        <span class="c1">#    self.log = Log()</span>
    
    <span class="k">def</span> <span class="nf">InputInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_info</span><span class="p">,</span> <span class="n">log</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
         <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_InputInfo</span><span class="p">()</span> 

         <span class="n">info</span><span class="o">.</span><span class="n">script</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_generator_dir</span><span class="p">(</span><span class="n">product_info</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">SHELL_INPUT_SCRIPT</span><span class="p">)</span>
         <span class="n">info</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
             <span class="n">info</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="n">info</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;InputInfo&quot;</span><span class="o">+</span><span class="n">__name__</span><span class="p">)</span>  <span class="c1">#nutils.Log()</span>
        
         <span class="n">info</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="mi">0</span>
                
         <span class="k">return</span> <span class="n">info</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conffile</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;NutShell2&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">conffile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_conf</span><span class="p">(</span><span class="n">conffile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="c1"># discarded</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>


    <span class="k">def</span> <span class="nf">read_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conffile</span> <span class="o">=</span> <span class="s1">&#39;nutshell.cnf&#39;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">conffile</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;reading conf file {0} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conffile</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">nutils</span><span class="o">.</span><span class="n">read_conf</span><span class="p">(</span><span class="n">conffile</span><span class="p">)</span>
            <span class="c1"># print result</span>
            <span class="n">nutils</span><span class="o">.</span><span class="n">set_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">strict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Conf file not found: &quot;</span> <span class="o">+</span> <span class="n">conffile</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Conf file not found: &quot;</span><span class="p">,</span> <span class="n">conffile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Conf file not found: &quot;</span> <span class="o">+</span> <span class="n">conffile</span><span class="p">)</span>
            <span class="c1">#print (&quot;Conf file not found: &quot;, conffile)  </span>

    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="k">return</span> <span class="n">nutils</span><span class="o">.</span><span class="n">get_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    
<div class="viewcode-block" id="ProductServer.get_product_dir"><a class="viewcode-back" href="../../nutshell-main.html#nutshell.nutshell.ProductServer.get_product_dir">[docs]</a>    <span class="k">def</span> <span class="nf">get_product_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns directory containing product generator script (generate.sh) and possible configurations etc&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">product_info</span><span class="o">.</span><span class="n">ID</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">get_time_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">TIMESTAMP</span> <span class="c1"># product_info.TIMESTAMP</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">timestamp</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">==</span> <span class="s1">&#39;LATEST&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">timevars</span> <span class="o">=</span> <span class="n">nutproduct</span><span class="o">.</span><span class="n">parse_timestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
                <span class="c1"># print timevars</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIME_DIR_SYNTAX</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">timevars</span><span class="p">)</span> <span class="c1"># + os.sep</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    
    
    <span class="k">def</span> <span class="nf">get_generator_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_info</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">PRODUCT_ROOT</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">product_info</span><span class="o">.</span><span class="n">ID</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

   

    <span class="c1"># Generalize?</span>
<div class="viewcode-block" id="ProductServer.ensure_output_dir"><a class="viewcode-back" href="../../nutshell-main.html#nutshell.nutshell.ProductServer.ensure_output_dir">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_output_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outdir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a writable directory, if non-existent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">original_umask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">outdir</span><span class="p">),</span> <span class="mi">0</span><span class="n">o775</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">original_umask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdir</span></div>


    <span class="k">def</span> <span class="nf">run_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">p</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No process&#39;</span><span class="p">)</span> 
            <span class="n">task</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">NOT_FOUND</span>
            <span class="k">return</span>

        <span class="n">stdout</span><span class="p">,</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">task</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span>        

        <span class="k">if</span> <span class="p">(</span><span class="n">stdout</span><span class="p">):</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">task</span><span class="o">.</span><span class="n">error_info</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">error_info</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>             
                    <span class="n">status</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">error_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">HTTPStatus</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Not HTTP error code: {0} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">CONFLICT</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">stderr</span><span class="p">):</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>  
        <span class="n">task</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">stderr</span>
        
                   
<div class="viewcode-block" id="ProductServer.get_input_list"><a class="viewcode-back" href="../../nutshell-main.html#nutshell.nutshell.ProductServer.get_input_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_input_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_info</span><span class="p">,</span> <span class="n">directives</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Used for reading dynamic input configuration generated by input.sh.</span>
<span class="sd">        directives determine how the product is generated. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">input_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">InputInfo</span><span class="p">(</span><span class="n">product_info</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">input_info</span><span class="o">.</span><span class="n">script</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;no input script: {0]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_info</span><span class="o">.</span><span class="n">script</span><span class="p">))</span>         
            <span class="k">return</span> <span class="n">input_info</span>   
        
        <span class="c1"># TODO generalize (how)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">product_info</span><span class="o">.</span><span class="n">get_param_env</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_info</span><span class="o">.</span><span class="n">script</span><span class="p">),</span>
                             <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">input_info</span><span class="o">.</span><span class="n">script</span><span class="o">.</span><span class="n">parent</span><span class="p">),</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="c1"># always</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="c1"># stdout for cmd-line and subprocess.PIPE (separate) for http usage</span>
                             <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                             <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_process</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">input_info</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>  <span class="c1"># log    </span>

        <span class="k">if</span> <span class="p">(</span><span class="n">input_info</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> 
            <span class="c1">#log.warning(&quot;inputsss&quot;)</span>
            <span class="n">nutils</span><span class="o">.</span><span class="n">read_conf_text</span><span class="p">(</span><span class="n">input_info</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">input_info</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">input_info</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;executing failed with error code={0}: {1} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">input_info</span><span class="o">.</span><span class="n">script</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">input_info</span><span class="o">.</span><span class="n">error_info</span><span class="p">)</span>
        <span class="c1">#    else:</span>
        <span class="c1">#        log.critical(&quot;input script reported no error info&quot;)</span>
                       
        <span class="k">return</span> <span class="n">input_info</span></div>
    

         
<div class="viewcode-block" id="ProductServer.run_generator"><a class="viewcode-back" href="../../nutshell-main.html#nutshell.nutshell.ProductServer.run_generator">[docs]</a>    <span class="k">def</span> <span class="nf">run_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_request</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Run shell script to generate a product. </span>
<span class="sd">        </span>
<span class="sd">         stdout and stderr are used for output.</span>
<span class="sd">        </span>
<span class="sd">        Attributes:</span>
<span class="sd">          product_request -- state at beginning of transition.</span>
<span class="sd">          params -- attempted new state.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">params</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">product_request</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;run_generator: &#39;</span> <span class="o">+</span> <span class="n">product_request</span><span class="o">.</span><span class="n">product_info</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
        <span class="n">product_request</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">product_request</span><span class="o">.</span><span class="n">generator_path</span><span class="p">),</span> <span class="c1">#&#39;./&#39;+self.SHELL_GENERATOR_SCRIPT,</span>
                             <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">product_request</span><span class="o">.</span><span class="n">generator_path</span><span class="o">.</span><span class="n">parent</span><span class="p">),</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>  <span class="c1">#self.stdout,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> <span class="c1"># Use same stream as stdout, be it os.stdout or subprocess.STDOUT</span>
                             <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                             <span class="n">env</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
              
        <span class="bp">self</span><span class="o">.</span><span class="n">run_process</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">product_request</span><span class="p">,</span> <span class="n">product_request</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>              
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">product_request</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
                <span class="n">log_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">product_request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.stdout.log&#39;</span><span class="p">)</span>
                <span class="n">product_request</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Writing STDOUT log: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_file</span><span class="p">))</span>            
                <span class="n">log_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">product_request</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">product_request</span><span class="o">.</span><span class="n">stderr</span><span class="p">):</span>
                <span class="n">log_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">product_request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.stderr.log&#39;</span><span class="p">)</span>
                <span class="n">product_request</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Writing STDERR log: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_file</span><span class="p">))</span>            
                <span class="n">log_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">product_request</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span></div>


<div class="viewcode-block" id="ProductServer.make_request"><a class="viewcode-back" href="../../nutshell-main.html#nutshell.nutshell.ProductServer.make_request">[docs]</a>    <span class="k">def</span> <span class="nf">make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_info</span><span class="p">,</span> <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MAKE&#39;</span><span class="p">],</span> <span class="n">directives</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">log</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot; Return path or log</span>
<span class="sd">        &#39;MAKE&#39;   - return the product, if in cache, else generate it and return</span>
<span class="sd">        &#39;DELETE&#39; - delete the product in cache</span>
<span class="sd">        &#39;INPUTS&#39; - generate and store the product, also regenerate even if already exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">product_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ProductRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_info</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">directives</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="n">product_request</span><span class="p">)</span></div>
        
        
<div class="viewcode-block" id="ProductServer.handle_request"><a class="viewcode-back" href="../../nutshell-main.html#nutshell.nutshell.ProductServer.handle_request">[docs]</a>    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot; Return path or log</span>
<span class="sd">        &#39;MAKE&#39;   - return the product, if in cache, else generate it and return</span>
<span class="sd">        &#39;DELETE&#39; - delete the product in cache</span>
<span class="sd">        &#39;INPUTS&#39; - generate and store the product, also regenerate even if already exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>  
            <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;File exists: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;DELETE&#39;</span> <span class="ow">in</span> <span class="n">pr</span><span class="o">.</span><span class="n">actions</span><span class="p">):</span>
                <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting...&#39;</span><span class="p">)</span>
                <span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="n">pr</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">ACCEPTED</span><span class="p">)</span>  <span class="c1">#202 # Accepted</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;MAKE&#39;</span> <span class="ow">in</span> <span class="n">pr</span><span class="o">.</span><span class="n">actions</span><span class="p">):</span> <span class="c1"># PATH_ONLY</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">pr</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">path</span>
                    <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Non-empty result file found: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
                    <span class="n">pr</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pr</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># BUSY</span>
                    <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;BUSY&#39;</span><span class="p">)</span> <span class="c1"># TODO riase (prevent deletion)</span>
                    <span class="n">pr</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">ACCEPTED</span><span class="p">)</span>  <span class="c1">#202 # Accepted</span>
                <span class="k">return</span> <span class="n">pr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;File not found: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>

        <span class="c1"># only check at this point</span>
        <span class="c1">#if (os.path.exists(pr.generator_script)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">generator_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Generator script ok: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">generator_path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Generator script not found: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">generator_path</span><span class="p">))</span>
            <span class="c1"># Consider case of copied valid product (without local generator)            </span>
            <span class="n">pr</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">NOT_IMPLEMENTED</span><span class="p">)</span> <span class="c1"># Not Implemented</span>
            <span class="k">return</span> <span class="n">pr</span>
        

        <span class="c1"># TODO: if not stream?</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;MAKE&#39;</span> <span class="ow">in</span> <span class="n">pr</span><span class="o">.</span><span class="n">actions</span><span class="p">):</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Ensuring cache dir for: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensure_output_dir</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path_tmp</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensure_output_dir</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

            <span class="c1"># what about true ENV?</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">product_info</span><span class="o">.</span><span class="n">get_param_env</span><span class="p">()</span> <span class="c1"># {})</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;OUTDIR&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path_tmp</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;OUTFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span>
            <span class="c1">#os.mknod(pr.path) # = touch</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
            
        <span class="c1"># Runs input.sh</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;MAKE&#39;</span> <span class="ow">in</span> <span class="n">pr</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;INPUTS&#39;</span> <span class="ow">in</span> <span class="n">pr</span><span class="o">.</span><span class="n">actions</span><span class="p">):</span>
            <span class="n">input_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input_list</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">product_info</span><span class="p">,</span> <span class="n">pr</span><span class="o">.</span><span class="n">directives</span><span class="p">,</span> <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s1">&#39;get_input_list&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">input_info</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">pr</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">input_info</span><span class="o">.</span><span class="n">inputs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#         pr.log.warn(&#39;Not HTTP error code: {0} &#39;.format(status))</span>
                <span class="n">pr</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">CONFLICT</span><span class="p">)</span>
                <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing: {0} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
                <span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">pr</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;MAKE&#39;</span> <span class="ow">in</span> <span class="n">pr</span><span class="o">.</span><span class="n">actions</span><span class="p">):</span> 
            <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Retrieving inputs for: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pr</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="c1">#pr.log.info(&#39;INPUTFILE: &#39; + i)</span>
                <span class="nb">input</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># &lt;filename&gt;.h5</span>
                <span class="n">input_prod_info</span> <span class="o">=</span> <span class="n">nutproduct</span><span class="o">.</span><span class="n">ProductInfo</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
                <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Make input: {0} ({1})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">input_prod_info</span><span class="o">.</span><span class="n">ID</span><span class="p">))</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_request</span><span class="p">(</span><span class="n">input_prod_info</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;MAKE&#39;</span><span class="p">],</span> <span class="p">[],</span> <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s2">&quot;input[{0}]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="c1"># sensitive</span>
                    <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Success: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;SKIPPED: &#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> 
            <span class="c1"># warn if  none succeeded?</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span>
            <span class="c1">#pr.log.extend2(pr.inputs , &#39;INPUTPATH: &#39;)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;INPUTKEYS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>

        <span class="c1"># MAIN</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;MAKE&#39;</span> <span class="ow">in</span> <span class="n">pr</span><span class="o">.</span><span class="n">actions</span><span class="p">):</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_generator</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;generator failed&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">pr</span>
                
            <span class="k">if</span> <span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path_tmp</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;generator failed&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">pr</span>
            
            <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Final move from tmp&quot;</span><span class="p">)</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">path_tmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
                
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;LINK&#39;</span> <span class="ow">in</span> <span class="n">pr</span><span class="o">.</span><span class="n">directives</span><span class="p">):</span> <span class="c1">#and pr.product_info.TIMESTAMP:</span>
                    <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;LINK: {0} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path_static</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ensure_output_dir</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path_static</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
                    <span class="n">nutils</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path_static</span><span class="p">,</span> <span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
         
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;LATEST&#39;</span> <span class="ow">in</span> <span class="n">pr</span><span class="o">.</span><span class="n">directives</span><span class="p">):</span>
                    <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;LATEST: {0} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path_latest</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ensure_output_dir</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path_latest</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
                    <span class="n">nutils</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path_latest</span><span class="p">,</span> <span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                 <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Linking file failed&quot;</span><span class="p">)</span>               
 
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span> <span class="ow">in</span> <span class="n">pr</span><span class="o">.</span><span class="n">directives</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;LOG&#39;</span> <span class="ow">in</span> <span class="n">pr</span><span class="o">.</span><span class="n">directives</span><span class="p">):</span>
                <span class="n">logfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span><span class="p">)</span>
                <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving log: {0} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logfile</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logfile</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="c1">#.decode(encoding=&#39;UTF-8&#39;))            </span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">pr</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Saving log failed&quot;</span><span class="p">)</span>               
                
        <span class="k">return</span> <span class="n">pr</span></div></div>
    




        
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">product_server</span> <span class="o">=</span> <span class="n">ProductServer</span><span class="p">()</span>

    <span class="c1">#print()</span>
    <span class="c1">#logger = logging.getLogger(__name__ + str(++product_server.counter))</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;NutShell&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1">#logger.debug(&quot;parsing arguments&quot;)</span>
    
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ProductServer</span><span class="o">.</span><span class="n">get_arg_parser</span><span class="p">()</span> <span class="c1"># ProductInfo.get_arg_parser(parser)</span>
    
    <span class="c1">#(options, args) = parser.parse_args()</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="c1">#logger.warning(*options.__dict__)  </span>
    
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">options</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="ow">in</span> <span class="n">nutils</span><span class="o">.</span><span class="n">VERBOSITY_LEVELS</span><span class="p">):</span>
            <span class="n">options</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">nutils</span><span class="o">.</span><span class="n">VERBOSITY_LEVELS</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">))</span>
        <span class="c1">#print(options)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>   
    
    <span class="n">product_server</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="n">product_server</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="c1"># NEW</span>
    <span class="n">product_info</span> <span class="o">=</span> <span class="n">nutproduct</span><span class="o">.</span><span class="n">ProductInfo</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">PRODUCT</span><span class="p">):</span>
        <span class="n">product_info</span><span class="o">.</span><span class="n">parse_filename</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">PRODUCT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;product not defined&quot;</span><span class="p">)</span>
    
        

    <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">CONF</span><span class="p">):</span>
        <span class="n">product_server</span><span class="o">.</span><span class="n">read_conf</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">CONF</span><span class="p">)</span>

    <span class="c1">#if (options.VERBOSE &gt; 4):</span>
    <span class="c1">#nutils.print_dict(product_server.get_status())</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">product_server</span><span class="o">.</span><span class="n">get_status</span><span class="p">())</span>
     
    <span class="n">request</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">INPUTS</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;INPUTS&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">REQUEST</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">REQUEST</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">DELETE</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;DELETE&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">MAKE</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;MAKE&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">product_info</span><span class="o">.</span><span class="n">ID</span> <span class="ow">and</span> <span class="n">product_info</span><span class="o">.</span><span class="n">FORMAT</span><span class="p">):</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Requests: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">)))</span>

        <span class="n">directives</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">DIRECTIVES</span><span class="p">):</span>
            <span class="c1">#directives = nutils.read_conf_text(options.DIRECTIVES.split(&#39;,&#39;)) # whattabout comma in arg?</span>
            <span class="n">directives</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">DIRECTIVES</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="c1"># whattabout comma in arg?</span>

        <span class="n">product_request</span> <span class="o">=</span> <span class="n">product_server</span><span class="o">.</span><span class="n">make_request</span><span class="p">(</span><span class="n">product_info</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">directives</span><span class="p">,</span> <span class="n">logger</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s2">&quot;make_request&quot;</span><span class="p">))</span>
        <span class="c1">#logger.debug(product_request)</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;INPUTS&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="p">):</span> <span class="c1"># or (options.VERBOSE &gt; 6):</span>
            <span class="c1">#nutils.print_dict(product_request.inputs)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">product_request</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>

        <span class="c1">#        if (product_request.status.value &gt;= 500):</span>
        <span class="c1">#            print (product_request.stdout)</span>
        <span class="c1">#            print (product_request.stderr)</span>
        <span class="c1">#            logger.critical(product_request.status)</span>
        <span class="c1">#            exit(5)</span>
        <span class="c1">#        elif (product_request.status.value &gt;= 400):</span>
        <span class="c1">#            print (product_request.stdout)</span>
        <span class="c1">#            print (product_request.stderr)</span>
        <span class="c1">#            logger.error(product_request.status)</span>
        <span class="c1">#            exit(4)</span>
        <span class="c1">#        elif (product_request.status.value &gt;= 300):</span>
        <span class="c1">#            print (product_request.stdout)</span>
        <span class="c1">#            print (product_request.stderr)</span>
        <span class="c1">#            logger.warning(product_request.status)</span>
        <span class="c1">#            exit(3)</span>
        <span class="c1">#        else:            </span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">product_request</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>    
            
            
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not parse product&#39;</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#print(&#39;Could not parse product&#39;)</span>
        
    <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overall_scheme.html">Overall Scheme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nutshell-main.html">NutShell main modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nutshell.html">NutShell support modules</a></li>
</ul>

          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
            </form>
            <p class="searchtip" style="font-size: 90%">
                Enter search terms or a module, class or function name.
            </p>
          </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="../../py-modindex.html" title="Python Module Index"
              >modules</a> |
            <a href="../../genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &copy; Copyright 2020, Markus Peura.
      Last updated on May 10, 2020.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>